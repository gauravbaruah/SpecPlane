meta:
  purpose: "Generate well-formatted Markdown files from parsed SpecPlane YAML data, including proper sections, diagrams, references, and cross-links"
  type: "component"
  level: "component"
  domain: "documentation"
  status: "draft"
  last_updated: "2025-01-15"
  version: "0.1.0"
  id: "component.markdown_generator"
  owner: "SpecPlane Development Team"

contracts:
  capabilities:
    - "Generate structured Markdown with proper heading hierarchy (H1 for ID, H2 for top-level keys, H3 for second-level keys)"
    - "Create Docusaurus-compatible frontmatter with proper document IDs and routing"
    - "Create meta section as the first section with key information formatted as bulleted list"
    - "Generate relationship diagrams showing component dependencies with default Mermaid graph if none present"
    - "Format diagrams section with Mermaid code blocks for interactive rendering"
    - "Structure contracts section with clear behavioral definitions and inline code for event data"
    - "Format validation section with acceptance criteria and edge cases"
    - "Create clickable references and cross-references"
    - "Maintain consistent formatting and styling across all sections"
    - "Handle special characters and embedded content properly"
    - "Generate sections in specific order: Meta, Diagrams (with relationships), Contracts, Validation, Other, References, Specs YAML"
    - "Include complete YAML specification as code block at the end of markdown"
    - "Create default relationships diagram when no diagrams are present"
    - "Format meta fields as bulleted list with bold labels"
    - "Generate GitHub source links in meta section for original spec files"
    - "Preserve original YAML formatting, spacing, and key order from source files"
    - "Integrate with Git repositories to detect remote URLs and current branches"
    - "Use original YAML file content directly instead of re-serializing to maintain authenticity"
  
  apis:
    - "generateMarkdown(specData: SpecPlaneData, outputPath: string, originalFilePath: string) -> string"
    - "generateFrontmatter(meta: MetaData, outputPath: string) -> string"
    - "generateMetaSection(meta: MetaData, originalFilePath: string) -> string"
    - "generateRelationshipDiagram(relationships: Relationships) -> string"
    - "generateDiagramsSection(diagrams: Diagram[]) -> string"
    - "generateContractsSection(contracts: Contracts) -> string"
    - "generateValidationSection(validation: Validation) -> string"
    - "generateReferencesSection(refs: References) -> string"
    - "generateDefaultRelationshipsDiagram(specData: SpecPlaneData) -> string"
    - "generateGenericSection(key: string, value: any) -> string"
    - "generateSpecsYamlSection(specData: SpecPlaneData, originalFilePath: string) -> string"
    - "generateAnchor(text: string) -> string"
    - "capitalizeFirst(text: string) -> string"
    - "getGitInfo(filePath: string) -> GitInfo | null"
    - "findGitRoot(startPath: string) -> string | null"
  
  integrations:
    - "Mermaid diagram generation - For relationship and architecture diagrams"
    - "Markdown formatting libraries - For consistent output styling"
    - "Reference resolution system - For cross-linking between specifications"
    - "Template engine - For consistent section formatting"
    - "Git integration - For detecting repository information and generating source links"
    - "File system access - For reading original YAML files to preserve formatting"
    - "js-yaml library - For YAML parsing with key order preservation"
  
  events:
    - "markdown_generation_started: {spec_id, generation_time, timestamp}"
    - "section_generated: {spec_id, section_name, content_length, timestamp}"
    - "diagram_rendered: {spec_id, diagram_type, diagram_size, timestamp}"
    - "references_resolved: {spec_id, refs_count, cross_refs_count, timestamp}"
    - "git_info_detected: {spec_id, git_url, branch, timestamp}"
    - "original_yaml_preserved: {spec_id, file_path, content_length, timestamp}"
    - "markdown_completed: {spec_id, total_sections, total_size, generation_time}"

dependencies:
  internal:
    - "spec2md_converter - Parent container for orchestration"
    - "yaml_parser - For parsed SpecPlane data input"
  
  external:
    - "Markdown formatting libraries - For consistent output"
    - "Mermaid diagram libraries - For diagram generation"
    - "Template engines - For section formatting"
    - "js-yaml library - For YAML parsing and serialization"
    - "Git command line tools - For repository information detection"
    - "File system APIs - For reading original YAML files"

constraints:
  performance:
    response_time: "<1s for typical specification markdown generation"
    memory_usage: "<30MB heap size during generation"
    throughput: "Generate markdown for 100+ files in under 2 minutes"
    scalability: "Handle specifications with 100+ sections and diagrams"
  
  security_privacy:
    authentication: "No authentication required"
    authorization: "File system permissions determine access"
    data_protection: "No sensitive data extraction or logging"
    compliance: "Follow organization's documentation policies"
  
  technical:
    compatibility: "Node.js 16+ compatibility"
    markdown_standard: "CommonMark 0.31 specification compliance"
    diagram_support: "Mermaid diagram syntax support"
    encoding: "UTF-8 support for international content"

observability:
  monitoring:
    metrics:
      - "Markdown generation success rate and timing"
      - "Section generation performance by type"
      - "Diagram rendering success rate and timing"
      - "Reference resolution performance and accuracy"
      - "Output file size distribution"
    
    logs:
      - "Generation process logs with timing and status"
      - "Section generation logs with content metrics"
      - "Diagram rendering logs with success/failure status"
      - "Reference resolution logs with cross-link statistics"
    
    traces:
      - "End-to-end markdown generation pipeline"
      - "Section-by-section generation process"
      - "Diagram rendering and embedding process"
      - "Reference resolution and cross-linking process"
  
  alerting:
    critical:
      - "High markdown generation failure rates (>5%)"
      - "Diagram rendering system failures"
      - "Reference resolution system failures"
    
    warning:
      - "Slow generation performance (>2s per file)"
      - "High diagram rendering failure rates"
      - "Large output file sizes (>1MB)"
  
  slis:
    - "Markdown generation success rate: 98%"
    - "Average generation time: <1s per file"
  
  slos:
    - "Single file markdown generation completes within 1 second"
    - "Generation of 100 files completes within 2 minutes"
    - "Memory usage stays under 30MB during operations"

validation:
  acceptance_criteria:
    - "Markdown output follows specified section order and structure"
    - "Meta section appears first with all key information and source links"
    - "Relationship diagrams are properly embedded as Mermaid code blocks"
    - "All sections maintain proper heading hierarchy (H1, H2, H3)"
    - "References are clickable and properly formatted"
    - "Generated markdown renders correctly in Docusaurus"
    - "Cross-references between specifications work properly"
    - "Output maintains consistent formatting and styling"
    - "Source links in meta section point to correct GitHub URLs"
    - "YAML section preserves original formatting and key order"
    - "Git integration works for repositories with remote URLs"
  
  edge_cases:
    - "Specifications with missing or incomplete sections"
    - "Very long content that exceeds typical markdown limits"
    - "Complex nested structures requiring deep heading levels"
    - "Special characters and non-ASCII content"
    - "Circular references between specifications"
    - "Very large diagrams or embedded content"
    - "YAML files with complex formatting that must be preserved"
    - "Git repositories without remote URLs or in detached HEAD state"
    - "Original YAML files that cannot be read or are corrupted"
    - "YAML files with special characters in file paths"
  
  assumptions:
    - "Input SpecPlane data is well-structured and validated"
    - "Mermaid diagram syntax is supported by target rendering system"
    - "File system has sufficient storage for generated markdown"
    - "Cross-references point to valid specification files"
    - "Original YAML files are accessible and readable"
    - "Git repositories have proper remote configuration when source links are needed"
    - "YAML files maintain consistent formatting that should be preserved"
  
  readiness: "draft"
  open_questions:
    - "Should we implement markdown templates for consistent styling?"
    - "How should we handle very long content sections?"
    - "What level of diagram customization should be supported?"
    - "Should we implement markdown validation before output?"
    - "How should we handle Git repositories with multiple remotes?"
    - "Should we support different YAML formatting preferences?"
    - "What fallback behavior should we use when Git info is unavailable?"

implementation_hints:
  api:
    languages: ["JavaScript/Node.js"]
    frameworks: ["ES6+ modules", "Template literals", "String manipulation"]
    processing: ["Stream processing for large content", "Template-based generation"]
    formatting: ["Consistent indentation", "Proper heading hierarchy", "Clean spacing"]
  
  markdown:
    structure: ["Section-based organization", "Consistent heading levels", "Proper list formatting"]
    diagrams: ["Mermaid code blocks", "Proper syntax highlighting", "Embedded rendering"]
    references: ["Clickable links", "Cross-reference resolution", "Reference sections"]

evidence:
  user_research: "Feedback on current markdown generation needs and formatting preferences"
  technical_analysis: "Analysis of existing markdown generation tools and Docusaurus compatibility"
  design_artifacts: "Markdown output templates and formatting guidelines"

diagrams:
  flowchart:
    - title: "Markdown Generation Flow"
      description: "Complete flow from parsed data to formatted markdown output"
      mermaid: |
        flowchart TD
            A[Parsed SpecPlane Data] --> B[Detect Git Repository]
            B --> C[Generate Meta Section with Source Link]
            C --> D[Generate Relationship Diagram]
            D --> E[Generate Diagrams Section]
            E --> F[Generate Contracts Section]
            F --> G[Generate Validation Section]
            G --> H[Generate Other Sections]
            H --> I[Generate References Section]
            I --> J[Generate Specs YAML with Original Formatting]
            J --> K[Apply Final Formatting]
            K --> L[Output Markdown File]
            
            style B fill:#e1f5fe
            style C fill:#e1f5fe
            style D fill:#e1f5fe
            style E fill:#e1f5fe
            style F fill:#e1f5fe
            style J fill:#fff3e0
            style L fill:#c8e6c9
  
  state:
    - title: "Section Generation States"
      description: "States during markdown generation process"
      mermaid: |
        stateDiagram-v2
            [*] --> Initializing
            Initializing --> GitDetection
            GitDetection --> MetaSection
            MetaSection --> RelationshipDiagram
            RelationshipDiagram --> DiagramsSection
            DiagramsSection --> ContractsSection
            ContractsSection --> ValidationSection
            ValidationSection --> OtherSections
            OtherSections --> ReferencesSection
            ReferencesSection --> SpecsYaml
            SpecsYaml --> Finalizing
            Finalizing --> [*]
            
            GitDetection --> Error : Git Detection Failed
            MetaSection --> Error : Generation Failed
            RelationshipDiagram --> Error : Diagram Failed
            DiagramsSection --> Error : Section Failed
            SpecsYaml --> Error : YAML Processing Failed
            Error --> [*]
