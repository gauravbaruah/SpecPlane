meta:
  purpose: "Frontend login widget that handles OAuth authentication via Google and Apple ID, with Firebase Firestore backend integration and onboarding flow trigger"
  type: "widget"
  level: "component"
  domain: "frontend"
  status: "draft"
  last_updated: "2025-01-15"
  version: "1.0.0"

refs:
  firebase_auth_docs:
    type: "doc"
    title: "Firebase Authentication Documentation"
    url: "https://firebase.google.com/docs/auth"
    owner: "Google Firebase"
    version: "v9"
    access: "public"
    tags: ["firebase", "auth", "oauth"]
    
  firestore_users_collection:
    type: "doc"
    title: "Firestore Users Collection Schema"
    url: "https://firebase.google.com/docs/firestore/manage-data/structure-data"
    owner: "Google Firebase"
    access: "public"
    tags: ["firebase", "firestore", "database"]
    
  google_oauth_scopes:
    type: "doc"
    title: "Google OAuth Scopes Documentation"
    url: "https://developers.google.com/identity/protocols/oauth2/scopes"
    owner: "Google"
    access: "public"
    tags: ["oauth", "google", "scopes"]
    
  apple_signin_docs:
    type: "doc"
    title: "Apple Sign In Documentation"
    url: "https://developer.apple.com/sign-in-with-apple/"
    owner: "Apple"
    access: "public"
    tags: ["oauth", "apple", "signin"]
    
  onboarding_spec:
    type: "doc"
    title: "Onboarding Screen Specification"
    path: "./onboarding_screen.yaml"
    owner: "Product Team"
    status: "active"
    tags: ["onboarding", "user-experience"]
    notes: "Complete onboarding flow specification with first name collection and mic permissions"

  figma_login_screen:
    type: "figma"
    title: "Login Screen"
    url: "https://www.figma.com/design/M5CF9jRe3xRx6Olf4WLgGP/PFIO-Designs?node-id=1340-3012&t=dAu3ujg0RFOqkakj-1"
    owner: "Katherine"
    status: "draft"
    tags: ["login", "screen"]
    notes: "Figma screen for the login widget"
    
  firebase_config_docs:
    type: "doc"
    title: "Firebase Project Configuration Guide"
    url: "https://firebase.google.com/docs/projects/learn-more"
    owner: "Google Firebase"
    access: "public"
    tags: ["firebase", "setup", "configuration"]
    
  oauth_consent_guidelines:
    type: "doc"
    title: "OAuth Consent Message Guidelines"
    url: "TBD"
    owner: "Legal Team"
    status: "draft"
    tags: ["oauth", "consent", "legal", "privacy"]

contracts:
  interfaces:
    - "onGoogleSignIn() -> Promise<AuthResult>"
    - "onAppleSignIn() -> Promise<AuthResult>"
    - "onAuthSuccess(user: User) -> void"
    - "onAuthError(error: AuthError) -> void"
    - "onOnboardingTrigger(user: User) -> void"
    - "onConsentMessageDisplay() -> void"
    - "onTokenRefresh() -> Promise<boolean>"
    - "onSessionExpired() -> void"
    
  apis:
    - "Firebase Auth: signInWithPopup(GoogleAuthProvider) -> UserCredential | AuthError"
    - "Firebase Auth: signInWithPopup(AppleAuthProvider) -> UserCredential | AuthError"
    - "Firebase Auth: signOut() -> Promise<void>"
    - "Firestore: doc('users/{uid}').set(userData) -> Promise<void>"
    - "Firestore: doc('users/{uid}').get() -> DocumentSnapshot | Error"
    
  data_models:
    User:
      uid: "string - Firebase Auth UID"
      email: "string - User's email address"
      displayName: "string - User's display name"
      photoURL: "string - Profile picture URL"
      provider: "string - 'google' | 'apple'"
      createdAt: "timestamp - Account creation time"
      lastLoginAt: "timestamp - Last login time"
      onboardingCompleted: "boolean - Onboarding status"
      
    AuthResult:
      success: "boolean - Authentication result"
      user: "User | null - User data if successful"
      error: "AuthError | null - Error details if failed"
      provider: "string - OAuth provider used"
      
    AuthError:
      code: "string - Firebase error code"
      message: "string - Human-readable error message"
      email: "string - Email associated with error (if applicable)"
      credential: "AuthCredential | null - Credential if available"
    
  events:
    - "oauth_initiated: {provider, timestamp, session_id}"
    - "oauth_success: {provider, user_id, email, profile_picture, timestamp}"
    - "oauth_failure: {provider, error_code, error_message, timestamp}"
    - "user_created: {user_id, provider, email, timestamp}"
    - "onboarding_triggered: {user_id, timestamp}"
    - "login_error: {error_type, message, user_action, timestamp}"
    
  states:
    - "idle -> loading -> success|error"
    - "idle -> oauth_flow -> processing -> success|error"
    - "success -> onboarding_modal"
    - "error -> error_display -> idle"
    - "idle -> offline -> online -> idle"
    - "success -> session_expired -> idle"
    - "oauth_flow -> user_cancelled -> idle"
    - "processing -> user_exists -> onboarding_modal"

dependencies:
  internal:
    - "onboarding_screen"  # Component that handles user onboarding
    - "error_boundary"      # Error handling component
    - "loading_spinner"     # Loading state component
    - "user_context"        # User state management
    
  external:
    - "firebase/auth"       # Firebase Authentication SDK
    - "firebase/firestore"  # Firestore database SDK
    - "google-oauth2"       # Google OAuth 2.0 implementation
    - "apple-signin"        # Apple Sign In SDK

constraints:
  performance:
    response_time: "<2s for OAuth flow completion"
    loading_time: "<500ms for initial OAuth provider selection"
    error_display: "<100ms for error message rendering"
    
  security_privacy:
    authentication: "OAuth 2.0 with minimal scope access"
    authorization: "User consent required for profile data access"
    data_protection: "Only access email and profile picture from OAuth providers"
    compliance: "GDPR compliant data handling, clear consent messaging"
    consent_display: "OAuth consent message must be prominently displayed before authentication"
    data_retention: "User data retained until account deletion or 7 years of inactivity"
    audit_trail: "All authentication attempts logged with timestamp, IP, and user agent"
    permission_revocation: "Handle OAuth permission revocation gracefully with re-authentication flow"
    
  technical:
    compatibility: "Chrome 90+, Safari 14+, Firefox 88+, Edge 90+"
    accessibility: "WCAG 2.1 AA compliance, screen reader support"
    internationalization: "Support for multiple languages and locales"
    responsive: "Mobile-first design, touch-friendly interactions"
    firebase_config: "Firebase project must be configured with Google and Apple OAuth providers"
    environment_support: "Support for dev, staging, and production environments"
    offline_capability: "Graceful degradation when Firebase services unavailable"
    session_persistence: "Maintain user session across browser tabs and page refreshes"

observability:
  monitoring:
    metrics:
      - "oauth_success_rate by provider"
      - "oauth_failure_rate by error_type"
      - "oauth_flow_duration by provider"
      - "user_creation_success_rate"
      - "onboarding_trigger_rate"
      
    logs:
      - "OAuth flow initiation and completion"
      - "User creation in Firestore"
      - "Onboarding modal triggers"
      - "Error occurrences with context"
      
    traces:
      - "OAuth provider authentication flow"
      - "Firestore user document operations"
      - "Onboarding screen transitions"
      
  alerting:
    critical:
      - "OAuth success rate drops below 90%"
      - "User creation failures exceed 5%"
      - "Firebase service unavailability"
      
    warning:
      - "OAuth flow duration exceeds 3s P95"
      - "Onboarding trigger failures"
      - "High error rate for specific OAuth providers"

validation:
  acceptance_criteria:
    - "User can successfully authenticate with Google OAuth"
    - "User can successfully authenticate with Apple ID OAuth"
    - "OAuth consent message clearly states data access scope"
    - "User profile created in Firestore users collection after successful OAuth"
    - "Onboarding screen appears after successful authentication"
    - "Error messages are clear and actionable"
    - "Loading states provide clear feedback during OAuth flow"
    
  edge_cases:
    - "OAuth provider service unavailable -> Show fallback message with retry option"
    - "User denies OAuth permissions -> Clear error message about required permissions"
    - "Network timeout during OAuth -> Retry mechanism with exponential backoff"
    - "Firestore connection failure -> Queue user creation, show offline message"
    - "User already exists -> Skip user creation, proceed to onboarding"
    - "OAuth token expired -> Refresh token or re-authenticate"
    - "User cancels OAuth flow -> Return to idle state without error"
    - "OAuth permissions revoked -> Detect and prompt for re-authentication"
    - "Multiple tabs with different auth states -> Synchronize authentication state"
    - "Browser storage quota exceeded -> Fallback to session storage or memory"
    - "Firebase project configuration changes -> Detect and show configuration error"
    - "User switches between OAuth providers -> Clear previous provider state"
    
  assumptions:
    - "Firebase project is properly configured with OAuth providers"
    - "Google and Apple OAuth apps are registered and configured"
    - "Firestore security rules allow authenticated user creation"
    - "Onboarding screen component exists and can be triggered"
    - "User context provider handles authentication state management"
    - "Legal team has approved OAuth consent message content"
    - "Firebase project supports all required environments (dev/staging/prod)"
    - "Browser supports required Web APIs for OAuth flows"
    - "User has stable internet connection for OAuth provider communication"

  evidence:
    user_research: "OAuth preferred over email/password for mobile-first users"
    technical_analysis: "Firebase provides robust OAuth integration with minimal setup"
    design_artifacts: "Figma designs available for login widget and onboarding flow"

diagrams:
  sequence:
    - title: "OAuth Login Flow Sequence"
      description: "Complete OAuth authentication flow from user interaction to onboarding trigger"
      mermaid: |
        sequenceDiagram
            participant U as User
            participant L as Login Widget
            participant F as Firebase Auth
            participant G as Google/Apple OAuth
            participant S as Firestore
            participant O as Onboarding Screen
            
            U->>L: Click Google/Apple Sign In
            click L "{{refs.figma_login_screen.url}}" "Open Figma Login"
            L->>F: Initialize OAuth provider
            F->>G: Redirect to OAuth provider
            G-->>F: OAuth callback with code
            F->>F: Exchange code for tokens
            F->>F: Get user profile (email + picture only)
            F-->>L: Authentication success
            L->>S: Create/update user document
            S-->>L: User document created
            L->>O: Trigger onboarding modal
            O-->>U: Display onboarding screen
            
            Note over L,G: OAuth consent message:<br/>"We'll only access your profile<br/>picture and email address"
            
            alt OAuth Failure
                G-->>F: OAuth error
                F-->>L: Authentication failure
                L->>U: Display error message
            end
            
            alt Firestore Failure
                S-->>L: Database error
                L->>U: Show offline message
                L->>O: Still trigger onboarding
            end

  state:
    - title: "Login Widget State Management"
      description: "Component states and transitions during OAuth flow"
      mermaid: |
        stateDiagram-v2
            [*] --> Idle
            
            Idle --> Loading : User clicks OAuth provider
            Loading --> OAuthFlow : OAuth provider redirects
            OAuthFlow --> Processing : OAuth callback received
            Processing --> Success : Authentication successful
            Processing --> Error : Authentication failed
            
            Success --> Onboarding : Trigger onboarding modal
            Onboarding --> Idle : Onboarding completed
            
            Error --> ErrorDisplay : Show error message
            ErrorDisplay --> Idle : User dismisses error
            
            Loading --> Idle : User cancels OAuth
            OAuthFlow --> Idle : User cancels OAuth

  flowchart:
    - title: "OAuth Error Handling Flow"
      description: "Decision tree for handling various OAuth failure scenarios"
      mermaid: |
        flowchart TD
            A[OAuth Error Occurs] --> B{Error Type?}
            
            B -->|Permission Denied| C[Show Permission Required Message]
            B -->|Service Unavailable| D[Show Service Unavailable + Retry]
            B -->|Network Timeout| E[Show Network Error + Retry]
            B -->|Invalid Request| F[Show Technical Error + Contact Support]
            B -->|User Cancelled| G[Return to Idle State]
            
            C --> H[Display: "Google/Apple access required for login"]
            D --> I[Display: "Service temporarily unavailable. Please try again."]
            E --> J[Display: "Connection timeout. Please check your internet."]
            F --> K[Display: "Technical issue. Please contact support."]
            
            H --> L[Return to Idle]
            I --> M[Show Retry Button]
            J --> M
            K --> L
            
            M --> N[Retry OAuth Flow]
            N --> O{Retry Success?}
            O -->|Yes| P[Continue with Success Flow]
            O -->|No| Q[Increment Retry Count]
            Q --> R{Max Retries?}
            R -->|No| M
            R -->|Yes| S[Show Final Error + Manual Contact]

  user_journey:
    - title: "OAuth Login User Journey"
      description: "End-to-end user experience from landing to onboarding"
      mermaid: |
        journey
            title OAuth Login Experience
            section Landing
              Arrive at login page     : 5: User
              See OAuth options       : 5: User
              Read consent message    : 4: User
            section Authentication
              Click Google/Apple      : 5: User
              Complete OAuth flow     : 4: User
              Grant permissions       : 3: User
            section Onboarding
              See welcome message     : 5: User
              Complete profile setup  : 4: User
              Start using app         : 5: User

  flowchart:
    - title: "Consent Message Display Flow"
      description: "How and when OAuth consent message is displayed to users"
      mermaid: |
        flowchart TD
            A[User arrives at login] --> B{First time user?}
            B -->|Yes| C[Display full consent message]
            B -->|No| D[Display abbreviated consent]
            
            C --> E[Show detailed privacy notice]
            D --> F[Show brief reminder]
            
            E --> G[User reads consent]
            F --> H[User acknowledges]
            
            G --> I{User accepts?}
            H --> I
            
            I -->|Yes| J[Enable OAuth buttons]
            I -->|No| K[Show alternative options]
            
            J --> L[Proceed with OAuth]
            K --> M[Offer email/password or contact support]
            
            L --> N[OAuth flow initiated]
            M --> O[User chooses alternative path]  